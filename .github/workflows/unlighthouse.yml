name: Unlighthouse CI

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2AM UTC
  workflow_dispatch:
    inputs:
      run_competitors:
        description: 'Run competitor analysis'
        required: false
        default: false
        type: boolean
  repository_dispatch:
    types: [manual-scan]

permissions:
  contents: read

jobs:
  unlighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Chrome for Puppeteer
        run: npx puppeteer browsers install chrome

      - name: Get Chrome Path
        id: chrome-path
        run: echo "path=$(npx puppeteer browsers install chrome | grep chrome@ | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Generate URLs
        run: npm run urls
        env:
          SITEMAP_URL: ${{ secrets.SITEMAP_URL }}

      - name: Run Mobile Scan
        run: npm run scan:mobile
        env:
          PUPPETEER_EXECUTABLE_PATH: ${{ steps.chrome-path.outputs.path }}

      - name: Run Desktop Scan
        run: npm run scan:desktop
        env:
          PUPPETEER_EXECUTABLE_PATH: ${{ steps.chrome-path.outputs.path }}

      - name: Publish Reports (Local)
        run: npm run publish
        env:
          KEEP_RUNS: ${{ secrets.KEEP_RUNS }}

      - name: Upload Reports to KV Storage
        run: |
          if [ -z "$DASHBOARD_URL" ]; then
            echo "DASHBOARD_URL not configured, skipping upload"
            exit 0
          fi
          node scripts/upload-reports.mjs
        env:
          DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
          CI_UPLOAD_SIGNING_KEY: ${{ secrets.CI_UPLOAD_SIGNING_KEY }}

      - name: Check for Regressions
        run: npm run check-regression || true
        env:
          REGRESSION_THRESHOLD: ${{ secrets.REGRESSION_THRESHOLD }}

      - name: Send Slack Notification
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping notification"
            exit 0
          fi
          npm run notify
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}

      - name: Trigger Vercel Redeploy
        if: success()
        run: |
          if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
            curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
            echo "Triggered Vercel deployment"
          else
            echo "VERCEL_DEPLOY_HOOK not configured, skipping redeploy trigger"
          fi

  competitor-analysis:
    runs-on: ubuntu-latest
    needs: unlighthouse
    if: |
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'workflow_dispatch' && inputs.run_competitors == true) ||
      github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Competitor Analysis
        run: |
          if [ -z "$DASHBOARD_URL" ]; then
            echo "DASHBOARD_URL not configured, skipping competitor analysis"
            exit 0
          fi
          echo "Running competitor analysis..."
          # The competitor analysis is handled by the dashboard API
          # This job triggers the dashboard to refresh competitor data
          # DataForSEO credentials are configured on the dashboard, not in this workflow
          curl -X POST "${DASHBOARD_URL}/api/competitors" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${CI_UPLOAD_SIGNING_KEY}" || echo "Competitor API call failed (non-fatal)"
        env:
          DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
          CI_UPLOAD_SIGNING_KEY: ${{ secrets.CI_UPLOAD_SIGNING_KEY }}

      - name: Notify Completion
        run: |
          echo "Competitor analysis completed at $(date)"
