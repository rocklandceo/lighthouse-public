name: Unlighthouse CI

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2AM UTC
  workflow_dispatch:
  repository_dispatch:
    types: [manual-scan]

permissions:
  contents: read

jobs:
  unlighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Chrome for Puppeteer
        run: npx puppeteer browsers install chrome

      - name: Get Chrome Path
        id: chrome-path
        run: |
          CHROME_PATH=$(node -e "const puppeteer = require('puppeteer'); console.log(puppeteer.executablePath())")
          echo "Resolved Chrome path: $CHROME_PATH"
          if [ ! -f "$CHROME_PATH" ]; then
            echo "ERROR: Chrome binary not found at $CHROME_PATH"
            exit 1
          fi
          if [ ! -x "$CHROME_PATH" ]; then
            echo "ERROR: Chrome binary at $CHROME_PATH is not executable"
            exit 1
          fi
          echo "Chrome binary verified: $CHROME_PATH"
          echo "path=$CHROME_PATH" >> $GITHUB_OUTPUT

      - name: Generate URLs
        run: |
          # TARGET_BASE_URL is required, SITEMAP_URL is optional (defaults to ${TARGET_BASE_URL}/sitemap.xml)
          if [ -z "$TARGET_BASE_URL" ]; then
            echo "ERROR: TARGET_BASE_URL secret is required"
            exit 1
          fi
          npm run urls
        env:
          TARGET_BASE_URL: ${{ secrets.TARGET_BASE_URL }}
          SITEMAP_URL: ${{ secrets.SITEMAP_URL }}

      - name: Run Mobile Scan
        run: npm run scan:mobile
        env:
          PUPPETEER_EXECUTABLE_PATH: ${{ steps.chrome-path.outputs.path }}

      - name: Run Desktop Scan
        run: npm run scan:desktop
        env:
          PUPPETEER_EXECUTABLE_PATH: ${{ steps.chrome-path.outputs.path }}

      - name: Publish Reports (Local)
        run: npm run publish
        env:
          KEEP_RUNS: ${{ secrets.KEEP_RUNS }}

      - name: Upload Reports to KV Storage
        run: |
          if [ -z "$DASHBOARD_URL" ]; then
            echo "DASHBOARD_URL not configured, skipping upload"
            exit 0
          fi
          node scripts/upload-reports.mjs
        env:
          DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
          CI_UPLOAD_SIGNING_KEY: ${{ secrets.CI_UPLOAD_SIGNING_KEY }}

      - name: Check for Regressions
        run: npm run check-regression || true
        env:
          REGRESSION_THRESHOLD: ${{ secrets.REGRESSION_THRESHOLD }}

      - name: Send Slack Notification
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping notification"
            exit 0
          fi
          npm run notify
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}

      - name: Trigger Vercel Redeploy
        if: success()
        run: |
          if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
            curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
            echo "Triggered Vercel deployment"
          else
            echo "VERCEL_DEPLOY_HOOK not configured, skipping redeploy trigger"
          fi

  # Note: Competitor analysis is triggered automatically by the dashboard
  # when viewing the Competitors tab or can be manually refreshed from the UI.
  # The /api/competitors endpoint requires session authentication and cannot
  # be called from GitHub Actions. DataForSEO credentials are configured in
  # Vercel environment variables, not in this workflow.
